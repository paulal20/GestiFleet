<%
  const isEditMode = (typeof vehiculo !== 'undefined' && vehiculo.id_vehiculo);
%>

<div class="vehiculo-form-content">
  <h1><%= title %></h1>

  <% if (typeof error !== 'undefined' && error) { %>
    <div class="alert alert-danger mt-2" role="alert" aria-live="assertive">
      <%= error %>
    </div>
  <% } %>

  <form id="vehiculoForm" action="<%= action %>" method="POST" data-id="<%= isEditMode ? vehiculo.id_vehiculo : '' %>" novalidate autocomplete="off" enctype="multipart/form-data">
    <% if (isEditMode) { %>
        <input type="hidden" name="_method" value="PUT">
    <% } %>
    <fieldset>
      <legend class="w-auto">Datos del Vehículo</legend>

      <div class="row">
        <div class="col-md-4 mb-3">
          <label for="matricula" class="form-label obligatorio">Matrícula:</label>
          <input type="text" id="matricula" name="matricula" class="form-control"
                      value="<%= (typeof vehiculo !== 'undefined' && vehiculo.matricula) ? vehiculo.matricula : '' %>" placeholder="1234ABC" required aria-describedby="error-matricula">
          <span class="error" id="error-matricula" aria-live="polite"></span>
        </div>
        <div class="col-md-4 mb-3">
          <label for="marca" class="form-label obligatorio">Marca:</label>
          <input type="text" id="marca" name="marca" class="form-control"
                      value="<%= (typeof vehiculo !== 'undefined' && vehiculo.marca) ? vehiculo.marca : '' %>" placeholder="BYD" required aria-describedby="error-marca">
          <span class="error" id="error-marca" aria-live="polite"></span>
        </div>
        <div class="col-md-4 mb-3">
          <label for="modelo" class="form-label obligatorio">Modelo:</label>
          <input type="text" id="modelo" name="modelo" class="form-control"
                      value="<%= (typeof vehiculo !== 'undefined' && vehiculo.modelo) ? vehiculo.modelo : '' %>" placeholder="Seal 1" required aria-describedby="error-modelo">
          <span class="error" id="error-modelo" aria-live="polite"></span>
        </div>
      </div>

      <div class="row">
        <div class="col-md-4 mb-3">
          <label for="anyo_matriculacion" class="form-label obligatorio">Año Matriculación:</label>
          <input type="number" id="anyo_matriculacion" name="anyo_matriculacion" class="form-control"
                      value="<%= (typeof vehiculo !== 'undefined' && vehiculo.anyo_matriculacion) ? vehiculo.anyo_matriculacion : '' %>" placeholder="2023" min="1901" max="2100" required aria-describedby="error-anyo_matriculacion">
          <span class="error" id="error-anyo_matriculacion" aria-live="polite"></span>
        </div>
        <div class="col-md-4 mb-3">
          <label for="precio" class="form-label obligatorio">Precio (€):</label>
          <input type="number" step="0.01" id="precio" name="precio" class="form-control"
                      value="<%= (typeof vehiculo !== 'undefined' && vehiculo.precio) ? vehiculo.precio : '' %>" placeholder="40000.00" required aria-describedby="error-precio">
          <span class="error" id="error-precio" aria-live="polite"></span>
        </div>
        <div class="col-md-4 mb-3">
          <label for="numero_plazas" class="form-label NoObligatorio">Número de Plazas:</label>
          <input type="number" id="numero_plazas" name="numero_plazas" class="form-control"
                      value="<%= (typeof vehiculo !== 'undefined' && vehiculo.numero_plazas) ? vehiculo.numero_plazas : 5 %>" placeholder="5" aria-describedby="error-numero_plazas">
          <span class="error" id="error-numero_plazas" aria-live="polite"></span>
        </div>
      </div>

      <div class="row">
        <div class="col-md-4 mb-3">
          <label for="autonomia_km" class="form-label NoObligatorio">Autonomía (km):</label>
          <input type="number" id="autonomia_km" name="autonomia_km" class="form-control"
                      value="<%= (typeof vehiculo !== 'undefined' && vehiculo.autonomia_km) ? vehiculo.autonomia_km : '' %>" placeholder="520" aria-describedby="error-autonomia_km">
          <span class="error" id="error-autonomia_km" aria-live="polite"></span>
        </div>
        <div class="col-md-4 mb-3">
          <label for="color" class="form-label NoObligatorio">Color:</label>
          <input type="text" id="color" name="color" class="form-control"
                      value="<%= (typeof vehiculo !== 'undefined' && vehiculo.color) ? vehiculo.color : '' %>" placeholder="Gris" aria-describedby="error-color">
          <span class="error" id="error-color" aria-live="polite"></span>
        </div>
        <div class="col-md-4 mb-3">
          <label for="id_concesionario" class="form-label obligatorio">Concesionario:</label>
          <select id="id_concesionario" name="id_concesionario" class="form-select" required aria-describedby="error-id_concesionario">
            <option value="0">Selecciona un concesionario</option>
            <% concesionarios.forEach(c => { %>
              <option value="<%= c.id_concesionario %>" <%= (typeof vehiculo !== 'undefined' && vehiculo.id_concesionario == c.id_concesionario) ? 'selected' : '' %>><%= c.nombre %></option>
            <% }) %>
          </select>
          <span class="error" id="error-id_concesionario" aria-live="polite"></span>
        </div>
      </div>

      <div class="mb-3">
        <label for="descripcion" class="form-label NoObligatorio">Descripción:</label>
        <textarea id="descripcion" name="descripcion" class="form-control" rows="3" placeholder="Sedán eléctrico moderno con diseño aerodinámico y rendimiento eficiente para ciudad y carretera." aria-describedby="error-descripcion"><%= (typeof vehiculo !== 'undefined' && vehiculo.descripcion) ? vehiculo.descripcion : '' %></textarea>
        <span class="error" id="error-descripcion" aria-live="polite"></span>
      </div>

      <div class="mb-3">
        <label for="imagen" class="form-label <%= isEditMode ? '' : 'obligatorio' %>">Imagen (solo PNG):</label>
        
        <% if (isEditMode && vehiculo.imagen) { %>
          <div class="mb-2">
            <p class="mb-1 fw-semibold">Imagen actual:</p>
            <img src="/vehiculos/<%= vehiculo.id_vehiculo %>/imagen" alt="Imagen actual del vehículo"
                class="img-thumbnail shadow-sm" style="max-width: 250px; height: auto;" onerror="this.style.display='none'">
          </div>
        <% } %>

        <input type="file" id="imagen" name="imagen" class="form-control" accept=".png" <%= !isEditMode ? 'required' : '' %> aria-describedby="error-imagen">
        <span class="error" id="error-imagen" aria-live="polite"></span>
        <% if (isEditMode) { %>
          <small class="text-muted">Si no seleccionas una nueva imagen, se mantendrá la actual.</small>
        <% } %>
      </div>


    </fieldset>

    <div class="d-flex justify-content-end mt-3 gap-2">
      <a href="/vehiculos" class="btn btn-outline-secondary">Cancelar</a>
      <button type="submit" class="btn btn-primary">
        <%= isEditMode ? 'Actualizar Vehículo' : 'Crear Vehículo' %>
      </button>
    </div>
  </form>
</div>

<script src="/js/jquery.min.js"></script>
<script src="/js/jquery-ui.min.js"></script>
<script src="/js/jquery-3.7.1.min.js"></script>
<script src="/js/vehiculoForm.js"></script>
<script src="/js/ajax/vehiculos/vehiculosForm.js"></script>