<%
  const isEditMode = (typeof usuario !== 'undefined' && usuario.id_usuario) ? true : false;
  
  const rolValor = isEditMode ? usuario.rol : 'Empleado';
  
  const isSelf = (typeof usuarioSesion !== 'undefined' && isEditMode && usuarioSesion.id_usuario == usuario.id_usuario);

  const segundaFila = isEditMode ? 'col-md-6' : 'col-md-4';
%>

<div class="usuario-form-content">
  <h1><%= title %></h1>

  <% if (typeof error !== 'undefined' && error) { %>
    <div class="alert alert-danger mt-2" role="alert" aria-live="assertive">
      <%= error %>
    </div>
  <% } %>

    <form id="usuarioForm" action="<%= typeof action !== 'undefined' ? action : '' %>" novalidate autocomplete="off" 
        data-editmode="<%= isEditMode %>"
        data-id="<%= usuario?.id_usuario || '' %>">
    
    <% if (isSelf) { %>
        <input type="hidden" id="rol_hidden" name="rol" value="<%= rolValor %>">
    <% } %>

    <fieldset>
      <legend class="w-auto">Datos del Usuario</legend>

      <div class="row">
        <div class="col-md-4 mb-3">
          <label for="nombre" class="form-label obligatorio">Nombre:</label>
          <input type="text" id="nombre" name="nombre" class="form-control" 
                 value="<%= usuario?.nombre || '' %>" required aria-describedby="error-nombre">
          <span class="error" id="error-nombre" aria-live="polite"></span>
        </div>

        <div class="col-md-4 mb-3">
          <label for="apellido1" class="form-label obligatorio">Primer apellido:</label>
          <input type="text" id="apellido1" name="apellido1" class="form-control" 
                 value="<%= usuario?.apellido1 || '' %>" required aria-describedby="error-apellido1">
          <span class="error" id="error-apellido1" aria-live="polite"></span>
        </div>

        <div class="col-md-4 mb-3">
          <label for="apellido2" class="form-label NoObligatorio">Segundo apellido:</label>
          <input type="text" id="apellido2" name="apellido2" class="form-control"
                 value="<%= usuario?.apellido2 || '' %>" aria-describedby="error-apellido2">
          <span class="error" id="error-apellido2" aria-live="polite"></span>
        </div>
      </div>

      <div class="row">
        <div class="<%= segundaFila %> mb-3">
          <label for="email" class="form-label obligatorio">Correo electrónico:</label>
          <input type="email" id="email" name="email" class="form-control"
                 value="<%= usuario?.correo || '' %>" required aria-describedby="error-email" placeholder="@gestifleet.com/es">
          <span class="error" id="error-email" aria-live="polite"></span>
        </div>

        <% if (!isEditMode) { %>
          <div class="col-md-4 mb-3">
            <label for="confemail" class="form-label obligatorio">Confirmar correo:</label>
            <input type="email" id="confemail" name="confemail" class="form-control" 
                   required aria-describedby="error-confemail">
            <span class="error" id="error-confemail" aria-live="polite"></span>
          </div>
        <% } %>

        <div class="<%= segundaFila %> mb-3">
          <label for="contrasenya" class="form-label <%= isEditMode ? 'NoObligatorio' : 'obligatorio' %>">
            Contraseña <%= isEditMode ? '(vacio = no se cambia)' : '' %>:
          </label>
          <input type="password" id="contrasenya" name="contrasenya" class="form-control" 
                 placeholder="<%= isEditMode ? '••••••••' : '' %>" <%= isEditMode ? '' : 'required' %>
                 aria-describedby="error-contrasenya">
          <span class="error" id="error-contrasenya" aria-live="polite"></span>
          <div class="mostrar-contrasenya" style="margin-top:6px; display:flex; align-items:center; gap:8px;">
            <input type="checkbox" id="mostrarContrasenya" aria-controls="contrasenya" />
            <label for="mostrarContrasenya" style="cursor:pointer; user-select:none;">Mostrar contraseña</label>
          </div>
        </div>
      </div>
      
      <div class="row">
        <div class="col-md-4 mb-3">
          <label for="telefono" class="form-label obligatorio">Teléfono:</label>
          <input type="text" id="telefono" name="telefono" class="form-control"
                 value="<%= usuario?.telefono || '' %>" required aria-describedby="error-telefono">
          <span class="error" id="error-telefono" aria-live="polite"></span>
        </div>

        <div class="col-md-4 mb-3">
          <label for="rol" class="form-label obligatorio">Rol:</label>
          <select id="rol" name="rol" class="form-select" required <%= isSelf ? 'disabled' : '' %>>
            <option value="">Selecciona un rol</option>
            <option value="Empleado" <%= rolValor === 'Empleado' ? 'selected' : '' %>>Empleado</option>
            <option value="Admin" <%= rolValor === 'Admin' ? 'selected' : '' %>>Admin</option>
          </select>
          <% if (isSelf) { %>
            <div class="form-text text-muted">No puedes cambiar tu propio rol.</div>
          <% } %>
          <span class="error" id="error-rol" aria-live="polite"></span>
        </div>

        <div class="col-md-4 mb-3" id="div-concesionario" style="display: none;">
            <label for="id_concesionario" class="form-label obligatorio">Concesionario:</label>
            <select id="id_concesionario" name="id_concesionario" class="form-select" 
                    aria-describedby="error-id_concesionario">
                <option value="0">Selecciona un concesionario</option>
                <% if (typeof concesionarios !== 'undefined') { %>
                    <% concesionarios.forEach(c => { %>
                        <option value="<%= c.id_concesionario %>" <%= (typeof usuario !== 'undefined' && usuario.id_concesionario == c.id_concesionario) ? 'selected' : '' %>>
                        <%= c.nombre %>
                        </option>
                    <% }) %>
                <% } %>
            </select>
            <span class="error" id="error-id_concesionario" aria-live="polite"></span>
        </div>
      </div>

    </fieldset>

    <div class="d-flex justify-content-end mt-3 gap-2">
      <a href="<%= typeof cancelUrl !== 'undefined' ? cancelUrl : '/usuarios' %>" class="btn btn-outline-secondary">Cancelar</a>
      <button type="submit" class="btn btn-primary">
        <%= isEditMode ? 'Actualizar Usuario' : 'Crear Usuario' %>
      </button>
    </div>
  </form>
</div>

<script src="/js/jquery-3.7.1.min.js"></script>
<script src="/js/usuarioForm.js"></script> 
<script src="/js/ajax/usuarios/usuarioForm.js"></script>